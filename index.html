<!DOCTYPE HTML>
<html style="overflow:hidden; margin:0;"><head>
<link rel="stylesheet" type="text/css" src="css/style.css"></link>
   <!-- <script src="../stats.js/build/stats.min.js"></script><!---->
   <!-- <script src="js/demo-gui.js"></script><!---->
    <script src="../p2.js/build/p2.js"></script>
    <script src="js/p2.renderer.js"></script>
    <script type="text/javascript" src="../pixi.js/bin/pixi.js"></script>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body style="overflow:hidden; margin:0;" >

<img style="position:absolute; z-index:-1" src='parts/images/chest.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/head.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/hips.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/jaw.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Lhand.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Llowerarm.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Llowerleg.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Lupperarm.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Lupperleg.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Rhand.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Rlowerarm.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Rlowerleg.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Rupperarm.png'></img>
<img style="position:absolute; z-index:-1" src='parts/images/Rupperleg.png'></img>

    <script type="text/javascript">
/*
var doobstats = new Stats();
doobstats.setMode(0); // 0: fps, 1: ms
doobstats.domElement.style.position = 'absolute';
doobstats.domElement.style.left = '0px';
doobstats.domElement.style.top = '0px';
document.body.appendChild( doobstats.domElement );
/**/

var testsk = {};

/* Temp Textures for demo - probably use spritesheets*/
var TEXTURE_chest      = PIXI.Texture.fromImage("parts/images/chest.png");
var TEXTURE_head       = PIXI.Texture.fromImage("parts/images/head.png");
var TEXTURE_hips       = PIXI.Texture.fromImage("parts/images/hips.png");
var TEXTURE_jaw        = PIXI.Texture.fromImage("parts/images/jaw.png");
var TEXTURE_Lhand      = PIXI.Texture.fromImage("parts/images/Lhand.png");
var TEXTURE_Llowerarm  = PIXI.Texture.fromImage("parts/images/Llowerarm.png");
var TEXTURE_Llowerleg  = PIXI.Texture.fromImage("parts/images/Llowerleg.png");
var TEXTURE_Lupperarm  = PIXI.Texture.fromImage("parts/images/Lupperarm.png");
var TEXTURE_Lupperleg  = PIXI.Texture.fromImage("parts/images/Lupperleg.png");
var TEXTURE_Rhand      = PIXI.Texture.fromImage("parts/images/Rhand.png");
var TEXTURE_Rlowerarm  = PIXI.Texture.fromImage("parts/images/Rlowerarm.png");
var TEXTURE_Rlowerleg  = PIXI.Texture.fromImage("parts/images/Rlowerleg.png");
var TEXTURE_Rupperarm  = PIXI.Texture.fromImage("parts/images/Rupperarm.png");
var TEXTURE_Rupperleg  = PIXI.Texture.fromImage("parts/images/Rupperleg.png");
/**/







/*JSON STREAM*/
if (!window.WebSocket) {
        console.log("Your browser does not support web sockets!");
}
var socket = new WebSocket("ws://localhost:8181");
socket.onopen = function () {
    console.log('ws socket opened');
};
socket.onclose = function () {
     console.log('ws socket closed');
}
/*JSON STREAM*/

var trackedSkeletons = {}; 

socket.onmessage = function (event) {
        if (typeof event.data === "string") { // TODO events? gestures? 
            // Get the data in JSON format.
            var jsonObject = JSON.parse(event.data);
    
            // Display the skeleton joints.
            for (var i = 0; i < jsonObject.skeletons.length; i++) {

                var joints = {};
                joints.name = jsonObject.skeletons[i]['id'];
                joints.confidence = jsonObject.skeletons[i]['confidence'];

                for (var j = 0; j < jsonObject.skeletons[i].joints.length; j++) {

                    var joint = jsonObject.skeletons[i].joints[j];

                    switch(joint.name) {
                        case 'hipcenter':
                            joints.hipcenter = joint;
                            break;
                        case 'spine':
                            joints.spine = joint;
                            break;
                        case 'shouldercenter':
                            joints.shouldercenter = joint;
                            break;
                        case 'head':
                            joints.head = joint;
                            break;
                        case 'shoulderleft':
                            joints.shoulderleft = joint;
                            break;
                        case 'elbowleft':
                            joints.elbowleft = joint;
                            break;
                        case 'wristleft':
                           joints.wristleft = joint;
                            break;
                        case 'handleft':
                           joints.handleft = joint;
                            break;
                        case 'shoulderright':
                           joints.shoulderright = joint;
                            break;
                        case 'elbowright':
                            joints.elbowright = joint;
                            break;
                        case 'wristright':
                            joints.wristright = joint;
                            break;
                        case 'handright':
                            joints.handright = joint;
                            break;
                        case 'hipleft':
                            joints.hipleft = joint;
                            break;
                        case 'kneeleft':
                            joints.kneeleft = joint;
                            break;
                        case 'ankleleft':
                           joints.ankleleft = joint;
                            break;
                        case 'footleft':
                            joints.footleft = joint;
                            break;
                        case 'hipright':
                            joints.hipright = joint;
                            break;
                        case 'kneeright':
                            joints.kneeright = joint;
                            break;  
                        case 'ankleright':
                           joints.ankleright = joint;
                            break;
                        case 'footright':
                           joints.footright = joint;
                            break;
                    }

                }//for joints

                trackedSkeletons[joints.name] = joints; 

            }//for each skeletons
        }

       


        for (var k in trackedSkeletons){
            if (trackedSkeletons.hasOwnProperty(k)) {
                //console.log(k);
                //console.log(trackedSkeletons[k]);
                testsk.movePoints( trackedSkeletons[k]);
                break;
            }
        }

};







/* 
    todo: 
        1. manage kinect input - convert coordinates to same space as physics/renderer
        2. bind ragdoll to user skeleton from kinect - use confidence data to help ease oddities
        3. render sprites into ragdolls
        4. render multiple types / animated sprites into ragdolls
        5. gesture objects / inertia tracking for triggering sound
*/

        var bodyscale = 1.6;
        var limboverlap =       bodyscale*0.1,
            shouldersDistance = bodyscale*0.5,
            upperArmLength =    bodyscale*0.4,
            lowerArmLength =    bodyscale*0.4,
            upperArmSize =      bodyscale*0.2,
            lowerArmSize =      bodyscale*0.2,
            handLength =        bodyscale*0.25,
            handSize =          bodyscale*0.2,
            neckLength =        bodyscale*0.1,
            headRadius =        bodyscale*0.25,
            upperBodyLength =   bodyscale*0.6,
            pelvisLength =      bodyscale*0.4,
            upperLegLength =    bodyscale*0.5,
            upperLegSize =      bodyscale*0.2,
            lowerLegSize =      bodyscale*0.2,
            lowerLegLength =    bodyscale*0.6;

       
        var app = new p2.WebGLRenderer(function(){

            /* GLOBAL  */
            var OTHER =     Math.pow(2,1),
                BODYPARTS = Math.pow(2,2),
                GROUND =    Math.pow(2,3),
                OTHER =     Math.pow(2,4),
                BODYPARTS1 = Math.pow(2,5),
                BODYPARTS2 = Math.pow(2,6),
                BODYPARTS3 = Math.pow(2,7),
                BODYPARTS4 = Math.pow(2,8),
                BODYPARTS5 = Math.pow(2,9),
                BODYPARTS6 = Math.pow(2,10);
           
            var world = new p2.World({
                doProfiling:false,
              //  gravity : [0,0],
                  gravity : [0,-14],
            });

            this.setWorld(world);
            world.solver.iterations = 100;
            world.solver.tolerance = 0.1;
             /* GLOBAL  */


function mapcoords(coord_x,coord_y){//mapcoords needs work

    var f = .009;
    var x = 640;
    var y = 480;

    coord_x = coord_x * f - (x*f);
    coord_y = -coord_y * f + (y*f);
    var coord = [coord_x,coord_y];
    return coord;
}//mapcoords

function checkLimits(coord_x,coord_y, name){//checkLimits

    var result = false;
    var lim_x = 1080;
    var lim_y  = 980;
    if(coord_x > lim_x || coord_y > lim_y || coord_y < -100 || coord_x < -100){
        result = true;
        console.log('input limit Hit: ', coord_x,coord_y, name );
    }

    return result;
}//checkLimits





var kinectpShape =  new p2.Circle(.01);
var originbody   = new p2.Body({ mass: 0, position: [0,0] });
originbody.addShape(kinectpShape);
world.addBody(originbody);





var tl   = new p2.Body({ mass: 0, position: mapcoords( 640  , 0) });
tl.addShape(kinectpShape);
world.addBody(tl);
var tr   = new p2.Body({ mass: 0, position: mapcoords( 640  , 480) });
tr.addShape(kinectpShape);
world.addBody(tr);
var bl   = new p2.Body({ mass: 0, position: mapcoords( 0  , 0) });
bl.addShape(kinectpShape);
world.addBody(bl);
var br   = new p2.Body({ mass: 0, position: mapcoords( 0  , 480) });
br.addShape(kinectpShape);
world.addBody(br);





        /**/
        var skeleton =(function () { 
        //Convert kinect points to PIXI / p2.js space
         
            var skeleton = function(obj) {//init
                var self = this; 
                self.name = obj['name'];
                self.o = { mass: 0, position: [0,0] };

                self.points = [
                    self.ankleleft      = new p2.Body(self.o),
                    self.ankleright     = new p2.Body(self.o),
                    self.elbowleft      = new p2.Body(self.o),
                    self.elbowright     = new p2.Body(self.o),
                    self.footleft       = new p2.Body(self.o),
                    self.footright      = new p2.Body(self.o),
                    self.handleft       = new p2.Body(self.o),
                    self.handright      = new p2.Body(self.o),
                    self.head           = new p2.Body(self.o),
                    self.hipcenter      = new p2.Body(self.o),
                    self.hipleft        = new p2.Body(self.o),
                    self.hipright       = new p2.Body(self.o),
                    self.kneeleft       = new p2.Body(self.o),
                    self.kneeright      = new p2.Body(self.o),
                    self.shouldercenter = new p2.Body(self.o),
                    self.shoulderleft   = new p2.Body(self.o),
                    self.shoulderright  = new p2.Body(self.o),
                    self.spine          = new p2.Body(self.o),
                    self.wristleft      = new p2.Body(self.o),
                    self.wristright     = new p2.Body(self.o)
                ]; 

                for (var i = 0; i < self.points.length; i++) {
                    self.points[i].addShape(kinectpShape);
                    world.addBody(self.points[i]);
                }
       
             }//skeleton init
            skeleton.prototype = { /*modularize this*/

                movePoints: function(obj){

                if(
                   checkLimits(obj['ankleleft'].x, obj['ankleleft'].y , 'ankleleft')||
                   checkLimits(obj['ankleright'].x, obj['ankleright'].y , 'ankleright')||
                   checkLimits(obj['elbowleft'].x, obj['elbowleft'].y , 'elbowleft')||
                   checkLimits(obj['elbowright'].x, obj['elbowright'].y , 'elbowright')||
                   checkLimits(obj['footleft'].x, obj['footleft'].y , 'footleft')||
                   checkLimits(obj['footright'].x, obj['footright'].y , 'footright')||
                   checkLimits(obj['handleft'].x, obj['handleft'].y , 'handleft')||
                   checkLimits(obj['handright'].x, obj['handright'].y , 'handright')||
                   checkLimits(obj['head'].x, obj['head'].y , 'head')||
                   checkLimits(obj['hipcenter'].x, obj['hipcenter'].y , 'hipcenter')||
                   checkLimits(obj['hipleft'].x, obj['hipleft'].y , 'hipleft')||
                   checkLimits(obj['hipright'].x, obj['hipright'].y , 'hipright')||
                   checkLimits(obj['kneeleft'].x, obj['kneeleft'].y , 'kneeleft')||
                   checkLimits(obj['kneeright'].x, obj['kneeright'].y , 'kneeright')||
                   checkLimits(obj['shouldercenter'].x, obj['shouldercenter'].y , 'shouldercenter')||
                   checkLimits(obj['shoulderleft'].x, obj['shoulderleft'].y , 'shoulderleft')||
                   checkLimits(obj['shoulderright'].x, obj['shoulderright'].y , 'shoulderright')||
                   checkLimits(obj['spine'].x, obj['spine'].y , 'spine')||
                   checkLimits(obj['wristleft'].x, obj['wristleft'].y , 'wristleft')||
                   checkLimits(obj['wristright'].x, obj['wristright'].y , 'wristright')
                ){
                    return false;
                }

                    this.ankleleft.position       = mapcoords(obj['ankleleft'].x  , obj['ankleleft'].y);
                    this.ankleright.position      = mapcoords(obj['ankleright'].x  , obj['ankleright'].y);
                    this.elbowleft.position       = mapcoords(obj['elbowleft'].x  , obj['elbowleft'].y);
                    this.elbowright.position      = mapcoords(obj['elbowright'].x  , obj['elbowright'].y);
                    this.footleft.position        = mapcoords(obj['footleft'].x  , obj['footleft'].y);
                    this.footright.position       = mapcoords(obj['footright'].x  , obj['footright'].y);
                    this.handleft.position        = mapcoords(obj['handleft'].x  , obj['handleft'].y);
                    this.handright.position       = mapcoords(obj['handright'].x  , obj['handright'].y);
                    this.head.position            = mapcoords(obj['head'].x  , obj['head'].y);
                    this.hipcenter.position       = mapcoords(obj['hipcenter'].x  , obj['hipcenter'].y);
                    this.hipleft.position         = mapcoords(obj['hipleft'].x  , obj['hipleft'].y);
                    this.hipright.position        = mapcoords(obj['hipright'].x  , obj['hipright'].y);
                    this.kneeleft.position        = mapcoords(obj['kneeleft'].x  , obj['kneeleft'].y);
                    this.kneeright.position       = mapcoords(obj['kneeright'].x  , obj['kneeright'].y);
                    this.shouldercenter.position  = mapcoords(obj['shouldercenter'].x  , obj['shouldercenter'].y);
                    this.shoulderleft.position    = mapcoords(obj['shoulderleft'].x  , obj['shoulderleft'].y);
                    this.shoulderright.position   = mapcoords(obj['shoulderright'].x  , obj['shoulderright'].y);
                    this.spine.position           = mapcoords(obj['spine'].x  , obj['spine'].y);
                    this.wristleft.position       = mapcoords(obj['wristleft'].x  , obj['wristleft'].y);
                    this.wristright.position      = mapcoords(obj['wristright'].x  , obj['wristright'].y);
                },

                tempconnect : function(obj){

                    var h_link = new p2.LinearSpring(this.head, r1.head, {
                        restLength : 0,
                        stiffness : 200,
                        localAnchorA : [0 , 0],
                        localAnchorB : [0 , 0],
                    });
             
                    var p_link = new p2.LinearSpring(this.hipcenter, r1.pelvis, {
                        restLength : 0,
                        stiffness : 200,
                        localAnchorA : [0 , 0],
                        localAnchorB : [0 , 0],
                    });

                    var re_link = new p2.LinearSpring(this.elbowright, r1.upperRightArm, {
                        restLength : 0,
                        stiffness : 100,
                        localAnchorA : [0 , 0],
                        localAnchorB : [upperArmLength/2 ,0],
                    });

                    var le_link = new p2.LinearSpring(this.elbowleft, r1.upperLeftArm, {
                        restLength : 0,
                        stiffness : 100,
                        localAnchorA : [0 , 0],
                        localAnchorB : [-upperArmLength/2 ,0],
                    });

                    var rh_link = new p2.LinearSpring(this.wristright, r1.lowerRightArm, {
                        restLength : 0,
                        stiffness : 100,
                        localAnchorA : [0 , 0],
                        localAnchorB : [lowerArmLength/2 ,0],
                    });

                    var lh_link = new p2.LinearSpring(this.wristleft, r1.lowerLeftArm, {
                        restLength : 0,
                        stiffness : 100,
                        localAnchorA : [0 , 0],
                        localAnchorB : [-lowerArmLength/2 ,0],
                    });

                     var rhh_link = new p2.LinearSpring(this.handright, r1.rightHand, {
                        restLength : 0,
                        stiffness : 50,
                        localAnchorA : [0,0],
                        localAnchorB : [0,0],
                    });

                    var lhh_link = new p2.LinearSpring(this.handleft, r1.leftHand, {
                        restLength : 0,
                        stiffness : 50,
                        localAnchorA : [0,0],
                        localAnchorB : [0,0],
                    });


                    var rk_link = new p2.LinearSpring(this.kneeright, r1.upperRightLeg, {
                        restLength : 0,
                        stiffness : 200,
                        localAnchorA : [0 , 0],
                        localAnchorB : [0 , -upperLegLength/2],
                    });

                    var lk_link = new p2.LinearSpring(this.kneeleft, r1.upperLeftLeg, {
                        restLength : 0,
                        stiffness : 200,
                        localAnchorA : [0 , 0],
                        localAnchorB : [0 , -upperLegLength/2],
                    });

                    var rf_link = new p2.LinearSpring(this.footright, r1.lowerRightLeg, {
                        restLength : 0,
                        stiffness : 50,
                        localAnchorA : [0 , 0],
                        localAnchorB : [0 , -lowerLegLength/2],
                    });

                    var lf_link = new p2.LinearSpring(this.footleft, r1.lowerLeftLeg, {
                        restLength : 0,
                        stiffness : 50,
                        localAnchorA : [0 , 0],
                        localAnchorB : [0 , -lowerLegLength/2],
                    });

                    
                        world.addSpring(h_link);
                        world.addSpring(p_link);

                        world.addSpring(re_link);
                        world.addSpring(le_link);

                        world.addSpring(rh_link);
                        world.addSpring(lh_link);

                        world.addSpring(rhh_link);
                        world.addSpring(lhh_link);

                        world.addSpring(rk_link);
                        world.addSpring(lk_link);

                        world.addSpring(rf_link);
                        world.addSpring(lf_link);
                        
/**/
                
                }

            }//skeleton prototype methods      
            return skeleton;

        })();//skeleton
        /**/





        /*RAGDOLL OBJ*/
        /**/
        var ragdoll =(function () { 

            var ragdoll = function(obj) {//init ragdoll
            var self = this; 

                /* PARAMS
                    obj = {
                        name = ''
                        world = {},
                        offset = [x,y],
                        dimensions = {}
                    }
                /**/
                
        
            var bodyPartShapes = [];

            var headShape =      new p2.Rectangle(2*headRadius,2*headRadius),
                jawShape =       new p2.Rectangle(2*headRadius,2*headRadius),
                upperArmShape =  new p2.Rectangle(upperArmLength,upperArmSize),
                lowerArmShape =  new p2.Rectangle(lowerArmLength,lowerArmSize),
                handShape =      new p2.Rectangle(handLength,handSize),
                upperBodyShape = new p2.Rectangle(shouldersDistance,upperBodyLength),
                pelvisShape =    new p2.Rectangle(shouldersDistance,pelvisLength),
                upperLegShape =  new p2.Rectangle(upperLegSize,upperLegLength),
                lowerLegShape =  new p2.Rectangle(lowerLegSize,lowerLegLength);/**/





            bodyPartShapes.push(headShape,
                                jawShape,
                                upperArmShape,
                                lowerArmShape,
                                handShape,
                                upperBodyShape,
                                pelvisShape,
                                upperLegShape,
                                lowerLegShape);

            if(true){ //Toggle COLLISION BETWEEN RAGDOLLS 
            switch(obj.name){
                case '1':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS1;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '2': 
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS2;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '3':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS3;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS4|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '4':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS4;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '5':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS5;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS6;
                                }
                break; 
                 case '6':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS6;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5;
                                }
                break; 
            }
        }else{//NO COLLISON BETWEEN RAGDOLLS
            for(var i=0; i<bodyPartShapes.length; i++){
                var s = bodyPartShapes[i];
                s.collisionGroup = BODYPARTS;
                s.collisionMask =  GROUND|OTHER;
            }
        }//NO COLLISON BETWEEN RAGDOLLS
            /*
            BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6
            */



            // Lower legs
            self.lowerLeftLeg = new p2.Body({
                mass: 1,
                position: [-shouldersDistance/2  ,lowerLegLength / 2 ],
            });

            self.lowerRightLeg = new p2.Body({
                mass: 1,
                position: [shouldersDistance/2,lowerLegLength / 2],
            });

            self.lowerLeftLeg.addShape(lowerLegShape);
            self.lowerRightLeg.addShape(lowerLegShape);

            self.lowerLeftLeg.texture   = TEXTURE_Llowerleg;/*temp tex*/
            self.lowerRightLeg.texture  = TEXTURE_Rlowerleg;/*temp tex*/

            world.addBody(self.lowerLeftLeg);
            world.addBody(self.lowerRightLeg);

            // Upper legs
            self.upperLeftLeg = new p2.Body({
                mass: 1,
                position: [-shouldersDistance/2,self.lowerLeftLeg.position[1]+lowerLegLength/2 + upperLegLength / 2 ],
            });

            self.upperRightLeg = new p2.Body({
                mass: 1,
                position: [shouldersDistance/2,self.lowerRightLeg.position[1]+lowerLegLength/2 + upperLegLength / 2],
            });
            self.upperLeftLeg.addShape(upperLegShape);
            self.upperRightLeg.addShape(upperLegShape)
            ;
            self.upperLeftLeg.texture   = TEXTURE_Lupperleg;/*temp tex*/
            self.upperRightLeg.texture  = TEXTURE_Rupperleg;/*temp tex*/

            world.addBody(self.upperLeftLeg);
            world.addBody(self.upperRightLeg);

            // Pelvis
            self.pelvis = new p2.Body({
                mass: 1,
                position: [0, self.upperLeftLeg.position[1]+upperLegLength/2+pelvisLength/2],
            });
            self.pelvis.addShape(pelvisShape);
            self.pelvis.texture         = TEXTURE_hips; /*temp tex*/ 
            world.addBody(self.pelvis);

            // Upper body
            self.upperBody = new p2.Body({
                mass: 1,
                position: [0,self.pelvis.position[1]+pelvisLength/2+upperBodyLength/2],
            });

            self.upperBody.addShape(upperBodyShape);
            self.upperBody.texture      = TEXTURE_chest;  /*temp tex*/  
            world.addBody(self.upperBody);

            // Head
            self.head = new p2.Body({
                mass: 1,
                position: [0,self.upperBody.position[1]+upperBodyLength/2+headRadius+neckLength],
            });

            self.head.addShape(headShape);
            self.head.texture           = TEXTURE_head; /*temp tex*/ 
            world.addBody(self.head);


            // Jaw
            self.jaw = new p2.Body({
                mass: .2,
                position: [0,self.upperBody.position[1]+upperBodyLength/2+headRadius+neckLength],
            });

            self.jaw.addShape(jawShape);
            self.jaw.texture            = TEXTURE_jaw; /*temp tex*/  
            world.addBody(self.jaw);



            // Upper arms
            self.upperLeftArm = new p2.Body({
                mass: 1,
                position: [-shouldersDistance/2-upperArmLength/2, self.upperBody.position[1]+upperBodyLength/2],
            });

            self.upperRightArm = new p2.Body({
                mass: 1,
                position: [shouldersDistance/2+upperArmLength/2, self.upperBody.position[1]+upperBodyLength/2],
            });

            self.upperLeftArm.addShape(upperArmShape);
            self.upperRightArm.addShape(upperArmShape);
            self.upperLeftArm.texture   = TEXTURE_Lupperarm;/*temp tex*/
            self.upperRightArm.texture   = TEXTURE_Rupperarm;/*temp tex*/
            world.addBody(self.upperLeftArm);
            world.addBody(self.upperRightArm);
            /**/


            // lower arms
            self.lowerLeftArm = new p2.Body({
                mass: 1,
                position: [ self.upperLeftArm.position[0] - lowerArmLength/2 - upperArmLength/2,
                            self.upperLeftArm.position[1]],
            });
            self.lowerRightArm = new p2.Body({
                mass: 1,
                position: [ self.upperRightArm.position[0] + lowerArmLength/2 + upperArmLength/2,
                            self.upperRightArm.position[1]],
            });
            self.lowerLeftArm.addShape(lowerArmShape);
            self.lowerRightArm.addShape(lowerArmShape);
            self.lowerLeftArm.texture  = TEXTURE_Llowerarm;/*temp tex*/
            self.lowerRightArm.texture  = TEXTURE_Rlowerarm;/*temp tex*/
            world.addBody(self.lowerLeftArm);
            world.addBody(self.lowerRightArm);


            //hands
            self.leftHand = new p2.Body({
                mass: .5,
                position: [ self.lowerLeftArm.position[0], self.lowerLeftArm.position[1]],
            });
            self.rightHand = new p2.Body({
                mass: .5,
                position: [ self.lowerRightArm.position[0], self.lowerLeftArm.position[1]],
            });
            self.leftHand.addShape(handShape);
            self.rightHand.addShape(handShape);
            self.rightHand.texture      = TEXTURE_Rhand; /*temp tex*/  
            self.leftHand.texture       = TEXTURE_Lhand;/*temp tex*/ 
            world.addBody(self.leftHand);
            world.addBody(self.rightHand);




            // Neck joint
            var neckJoint = new p2.RevoluteConstraint(self.head, self.upperBody, {
                localPivotA: [0,-headRadius-neckLength/2],
                localPivotB: [0,upperBodyLength/2],
            });

            neckJoint.setLimits(-Math.PI / 8, Math.PI / 8);

            world.addConstraint(neckJoint);



            var jaw_link = new p2.LinearSpring(this.jaw, this.head, {
                restLength : 0,
                stiffness : 100,
                localAnchorA : [0 , 0],
                localAnchorB : [0 , 0],
            });
            // Jaw
            world.addSpring(jaw_link);


           // Neck joint
            var jawJoint = new p2.PrismaticConstraint(this.jaw, this.head, {
                localAnchorA : [0 , 0],
                localAnchorB : [0 , 0],
                localAxisA : [0,.01],
                upperLimit : .01,
                lowerLimit : .01
            });

            world.addConstraint(jawJoint);
            /**/





            // Knee joints
            var leftKneeJoint = new p2.RevoluteConstraint(self.lowerLeftLeg, self.upperLeftLeg, {
                localPivotA: [0, lowerLegLength/2],
                localPivotB: [0,-upperLegLength/2],
            });
            var rightKneeJoint= new p2.RevoluteConstraint(self.lowerRightLeg, self.upperRightLeg, {
                localPivotA: [0, lowerLegLength/2],
                localPivotB:[0,-upperLegLength/2],
            });
            leftKneeJoint.setLimits(-Math.PI / 3, Math.PI / 3);
            rightKneeJoint.setLimits(-Math.PI / 3, Math.PI / 3);
            world.addConstraint(leftKneeJoint);
            world.addConstraint(rightKneeJoint);

            // Hip joints
            var leftHipJoint = new p2.RevoluteConstraint(self.upperLeftLeg, self.pelvis, {
                localPivotA: [0, upperLegLength/2],
                localPivotB: [-shouldersDistance/2,-pelvisLength/2],
            });
            var rightHipJoint = new p2.RevoluteConstraint(self.upperRightLeg, self.pelvis, {
                localPivotA: [0, upperLegLength/2],
                localPivotB: [shouldersDistance/2,-pelvisLength/2],
            });
            world.addConstraint(leftHipJoint);
            world.addConstraint(rightHipJoint);

            // Spine
            var spineJoint = new p2.RevoluteConstraint(self.pelvis, self.upperBody, {
                localPivotA: [0,pelvisLength/2],
                localPivotB: [0,-upperBodyLength/2],
            });
            spineJoint.setLimits(-Math.PI / 8, Math.PI / 8);
            world.addConstraint(spineJoint);

        
            // Shoulders
            var leftShoulder = new p2.RevoluteConstraint(self.upperBody, self.upperLeftArm, {
                localPivotA:[-shouldersDistance/2, upperBodyLength/2],
                localPivotB:[upperArmLength/2,0],
            });
            var rightShoulder= new p2.RevoluteConstraint(self.upperBody, self.upperRightArm, {
                localPivotA:[shouldersDistance/2,  upperBodyLength/2],
                localPivotB:[-upperArmLength/2,0],
            });
            world.addConstraint(leftShoulder);
            world.addConstraint(rightShoulder);

            // Elbow joint
            var leftElbowJoint = new p2.RevoluteConstraint(self.lowerLeftArm, self.upperLeftArm, {
                localPivotA: [lowerArmLength/2, 0],
                localPivotB: [-upperArmLength/2,0],
            });
            var rightElbowJoint= new p2.RevoluteConstraint(self.lowerRightArm, self.upperRightArm, {
                localPivotA:[-lowerArmLength/2,0],
                localPivotB:[upperArmLength/2,0],
            });
            world.addConstraint(leftElbowJoint);
            world.addConstraint(rightElbowJoint);


            // Hand joint
            var leftHandJoint = new p2.RevoluteConstraint(self.leftHand, self.lowerLeftArm, {
                localPivotA: [handLength/2, 0],
                localPivotB: [-lowerArmLength/2,0],
            });
            var rightHandJoint= new p2.RevoluteConstraint(self.rightHand, self.lowerRightArm, {
                localPivotA:[-handLength/2,0],
                localPivotB:[lowerArmLength/2,0],
            });

            leftHandJoint.setLimits(-Math.PI / 6, Math.PI / 6);
            rightHandJoint.setLimits(-Math.PI / 6, Math.PI / 6);
            world.addConstraint(leftHandJoint);
            world.addConstraint(rightHandJoint);







            }//initragdoll

              ragdoll.prototype = {

                    bindToSkeleton : function(obj){//Bind to Kinect Skeleton
                        //move spring attachment here
                    },
                    unbindFromSkeleton : function(obj){//unbind from Kinect Skeleton
                    },
                    decorate : function(obj){//decorate limbs with sprites
                    }

               }//ragdoll prototype methods      

            return ragdoll;
        })();//ragdoll
        /**/



        var r1 = new ragdoll({
            name:'1'
        });
        testsk = new skeleton({'name' : ''});
        window.setTimeout(function(){
                testsk.tempconnect({});
        },100);


        window.setTimeout(function(){ 
            var r2 = new ragdoll({
                name:'2'
             });
         },3000);


         window.setTimeout(function(){ 
            var r3 = new ragdoll({
                name:'3'
             });
         },6000);

         /*
        window.setTimeout(function(){ 
            var r4 = new ragdoll({
                name:'4'
             });
         },8000);

        window.setTimeout(function(){ 
            var r5 = new ragdoll({
                name:'5'
             });
         },10000);

        window.setTimeout(function(){ 
            var r6 = new ragdoll({
                name:'6'
             });
         },12000);
*/

    
            // Create ground
            var planeShape = new p2.Plane();
            var plane = new p2.Body({
                position:[0,-.9],
            });



            plane.addShape(planeShape);
            planeShape.collisionGroup = GROUND;
            planeShape.collisionMask =  BODYPARTS|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
          world.addBody(plane);
/*  */




            this.newShapeCollisionGroup = OTHER;
            this.newShapeCollisionMask =  BODYPARTS|OTHER|GROUND|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
            

        });
/**/




//app.container





/*FITERS DEMO
var filtersSwitchs = [true, false, false, false, false, false, false, false, false, false, false];

var displacementTexture = PIXI.Texture.fromImage("parts/displacement_map.png");
    var displacementFilter = new PIXI.DisplacementFilter(displacementTexture);

    var displacementFolder = gui.addFolder('Displacement');
    displacementFolder.add(filtersSwitchs, '0').name("apply");
    displacementFolder.add(displacementFilter.scale, 'x', 1, 200).name("scaleX");
    displacementFolder.add(displacementFilter.scale, 'y', 1, 200).name("scaleY");

    var blurFilter = new PIXI.BlurFilter();

blurFolder.add(filtersSwitchs, '1').name("apply");
    var blurFolder = gui.addFolder('Blur');
    blurFolder.add(filtersSwitchs, '1').name("apply");
    blurFolder.add(blurFilter, 'blurX', 0, 32).name("blurX");
    blurFolder.add(blurFilter, 'blurY', 0, 32).name("blurY");

    ////
    var pixelateFilter = new PIXI.PixelateFilter();

    var pixelateFolder = gui.addFolder('Pixelate');
    pixelateFolder.add(filtersSwitchs, '2').name("apply");
    pixelateFolder.add(pixelateFilter.size, 'x', 1, 32).name("PixelSizeX");
    pixelateFolder.add(pixelateFilter.size, 'y', 1, 32).name("PixelSizeY");

    ////

    var invertFilter = new PIXI.InvertFilter();

    var invertFolder = gui.addFolder('Invert');
    invertFolder.add(filtersSwitchs, '3').name("apply");
    invertFolder.add(invertFilter, 'invert', 0, 1).name("Invert");

    ////

    var grayFilter = new PIXI.GrayFilter();

    var grayFolder = gui.addFolder('Gray');
    grayFolder.add(filtersSwitchs, '4').name("apply");
    grayFolder.add(grayFilter, 'gray', 0, 1).name("Gray");

    ////

    var sepiaFilter = new PIXI.SepiaFilter();

    var sepiaFolder = gui.addFolder('Sepia');
    sepiaFolder.add(filtersSwitchs, '5').name("apply");
    sepiaFolder.add(sepiaFilter, 'sepia', 0, 1).name("Sepia");

    ////

    var twistFilter = new PIXI.TwistFilter();

    var twistFolder = gui.addFolder('Twist');
    twistFolder.add(filtersSwitchs, '6').name("apply");
    twistFolder.add(twistFilter, 'angle', 0, 10).name("Angle");
    twistFolder.add(twistFilter, 'radius', 0, 1).name("Radius");
    
    twistFolder.add(twistFilter.offset, 'x', 0, 1).name("offset.x");;
    twistFolder.add(twistFilter.offset, 'y', 0, 1).name("offset.y");;

    ////

    var dotScreenFilter = new PIXI.DotScreenFilter();

    var dotScreenFolder = gui.addFolder('DotScreen');
    dotScreenFolder.add(filtersSwitchs, '7').name("apply");
    dotScreenFolder.add(dotScreenFilter, 'angle', 0, 10);
    dotScreenFolder.add(dotScreenFilter, 'scale', 0, 1);

    ////

    var colorStepFilter = new PIXI.ColorStepFilter();
    
    var colorStepFolder = gui.addFolder('ColorStep');
    colorStepFolder.add(filtersSwitchs, '8').name("apply");

    colorStepFolder.add(colorStepFilter, 'step', 1, 100);
    colorStepFolder.add(colorStepFilter, 'step', 1, 100);
    ////

    var crossHatchFilter = new PIXI.CrossHatchFilter();
    
    var crossHatchFolder = gui.addFolder('CrossHatch');
    crossHatchFolder.add(filtersSwitchs, '9').name("apply");

    var rgbSplitterFilter = new PIXI.RGBSplitFilter();
    
    var rgbSplitFolder = gui.addFolder('RGB Splitter');
    rgbSplitFolder.add(filtersSwitchs, '10').name("apply");

    var filterCollection = [displacementFilter, blurFilter, pixelateFilter, invertFilter, grayFilter, sepiaFilter, twistFilter, dotScreenFilter, colorStepFilter, crossHatchFilter, rgbSplitterFilter];

    var container = app.container;
    var stage = app.stage;
    var renderer = app.renderer;

    displacementFilter.scale.x = 50;
    displacementFilter.scale.y = 50;

    var count = 0;
    var filtersToApply = [];

   /*     for (var i = 0; i < filterCollection.length; i++) {
            if(filtersSwitchs[i])filtersToApply.push(filterCollection[i]);
        };
        container.filters = filtersToApply.length > 0 ? filtersToApply : null;
*/
  

    /*
    requestAnimFrame(animate);

    function animate() {
        
        count += 0.1;
        
        var blurAmount = Math.cos(count) ;
        var blurAmount2 = Math.sin(count * 0.8)  ;

        var filtersToApply = [];

        for (var i = 0; i < filterCollection.length; i++) {
            
            if(filtersSwitchs[i])filtersToApply.push(filterCollection[i]);
        };

        pondContainer.filters = filtersToApply.length > 0 ? filtersToApply : null;
    
        displacementFilter.offset.x = count * 10//blurAmount * 40;
        displacementFilter.offset.y = count * 10
        
        overlay.tilePosition.x = count * -10//blurAmount * 40;
        overlay.tilePosition.y = count * -10

       renderer.render(stage);
        requestAnimFrame( animate );
    }*/




    </script>


</body></html>
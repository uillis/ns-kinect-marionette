<!DOCTYPE HTML>
<html style="overflow:hidden; margin:0;"><head>
<link rel="stylesheet" type="text/css" src="css/style.css"></link>
    <script src="../stats.js/build/stats.min.js"></script>
    <!--<script src="js/demo-gui.js"></script>-->
    <script src="../p2.js/build/p2.js"></script>
    <script src="js/p2.renderer.js"></script>
    <script type="text/javascript" src="../pixi.js/bin/pixi.js"></script>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body style="overflow:hidden; margin:0;" >
    <script type="text/javascript">

var doobstats = new Stats();
doobstats.setMode(0); // 0: fps, 1: ms
doobstats.domElement.style.position = 'absolute';
doobstats.domElement.style.left = '0px';
doobstats.domElement.style.top = '0px';
document.body.appendChild( doobstats.domElement );

var testsk = {};

/*JSON STREAM*/
if (!window.WebSocket) {
        console.log("Your browser does not support web sockets!");
}
var socket = new WebSocket("ws://localhost:8181");
socket.onopen = function () {
    console.log('ws socket opened');
};
socket.onclose = function () {
     console.log('ws socket closed');
}
/*JSON STREAM*/

var trackedSkeletons = {}; 

socket.onmessage = function (event) {
        if (typeof event.data === "string") { // TODO events? gestures? 
            // Get the data in JSON format.
            var jsonObject = JSON.parse(event.data);
    
            // Display the skeleton joints.
            for (var i = 0; i < jsonObject.skeletons.length; i++) {

                var joints = {};
                joints.name = jsonObject.skeletons[i]['id'];
                joints.confidence = jsonObject.skeletons[i]['confidence'];

                for (var j = 0; j < jsonObject.skeletons[i].joints.length; j++) {

                    var joint = jsonObject.skeletons[i].joints[j];

                    switch(joint.name) {
                        case 'hipcenter':
                            joints.hipcenter = joint;
                            break;
                        case 'spine':
                            joints.spine = joint;
                            break;
                        case 'shouldercenter':
                            joints.shouldercenter = joint;
                            break;
                        case 'head':
                            joints.head = joint;
                            break;
                        case 'shoulderleft':
                            joints.shoulderleft = joint;
                            break;
                        case 'elbowleft':
                            joints.elbowleft = joint;
                            break;
                        case 'wristleft':
                           joints.wristleft = joint;
                            break;
                        case 'handleft':
                           joints.handleft = joint;
                            break;
                        case 'shoulderright':
                           joints.shoulderright = joint;
                            break;
                        case 'elbowright':
                            joints.elbowright = joint;
                            break;
                        case 'wristright':
                            joints.wristright = joint;
                            break;
                        case 'handright':
                            joints.handright = joint;
                            break;
                        case 'hipleft':
                            joints.hipleft = joint;
                            break;
                        case 'kneeleft':
                            joints.kneeleft = joint;
                            break;
                        case 'ankleleft':
                           joints.ankleleft = joint;
                            break;
                        case 'footleft':
                            joints.footleft = joint;
                            break;
                        case 'hipright':
                            joints.hipright = joint;
                            break;
                        case 'kneeright':
                            joints.kneeright = joint;
                            break;  
                        case 'ankleright':
                           joints.ankleright = joint;
                            break;
                        case 'footright':
                           joints.footright = joint;
                            break;
                    }

                }//for joints

                trackedSkeletons[joints.name] = joints; 

            }//for each skeletons
        }

       


        for (var k in trackedSkeletons){
            if (trackedSkeletons.hasOwnProperty(k)) {
                //console.log(k);
               // console.log(trackedSkeletons[k]);
                testsk.movePoints( trackedSkeletons[k]);
                break;
            }
        }

       
       

};







/* 
    todo: 
        1. manage kinect input - convert coordinates to same space as physics/renderer
        2. bind ragdoll to user skeleton from kinect - use confidence data to help ease oddities
        3. render sprites into ragdolls
        4. render multiple types / animated sprites into ragdolls
        5. gesture objects / inertia tracking for triggering sound
*/

        var shouldersDistance = 0.5,
            upperArmLength = 0.4,
            lowerArmLength = 0.4,
            upperArmSize = 0.2,
            lowerArmSize = 0.2,
            neckLength = 0.1,
            headRadius = 0.25,
            upperBodyLength = 0.6,
            pelvisLength = 0.4,
            upperLegLength = 0.5,
            upperLegSize = 0.2,
            lowerLegSize = 0.2,
            lowerLegLength = 0.5;

       
        var app = new p2.WebGLRenderer(function(){

            /* GLOBAL  */
            var OTHER =     Math.pow(2,1),
                BODYPARTS = Math.pow(2,2),
                GROUND =    Math.pow(2,3),
                OTHER =     Math.pow(2,4),

                BODYPARTS1 = Math.pow(2,5),
                BODYPARTS2 = Math.pow(2,6),
                BODYPARTS3 = Math.pow(2,7),
                BODYPARTS4 = Math.pow(2,8),
                BODYPARTS5 = Math.pow(2,9),
                BODYPARTS6 = Math.pow(2,10);
           
            var world = new p2.World({
                doProfiling:false,
                gravity : [0,-14],
            });

            this.setWorld(world);
            world.solver.iterations = 100;
            world.solver.tolerance = 0.1;
             /* GLOBAL  */


function mapcoords(coord_x,coord_y){//mapcoords needs work
var f = .009;
var x = 640;
var y = 320;

coord_x = coord_x * f - (x*f);
coord_y = -coord_y * f + (y*f);
var coord = [coord_x,coord_y];
return coord;
}//mapcoords



var kinectpShape =  new p2.Circle(.05);


var originbody   = new p2.Body({ mass: 0, position: [0,0] });
originbody.addShape(kinectpShape);
world.addBody(originbody);




var tl   = new p2.Body({ mass: 0, position: mapcoords( 640  , 0) });
tl.addShape(kinectpShape);
world.addBody(tl);
var tr   = new p2.Body({ mass: 0, position: mapcoords( 640  , 480) });
tr.addShape(kinectpShape);
world.addBody(tr);
var bl   = new p2.Body({ mass: 0, position: mapcoords( 0  , 0) });
bl.addShape(kinectpShape);
world.addBody(bl);
var br   = new p2.Body({ mass: 0, position: mapcoords( 0  , 480) });
br.addShape(kinectpShape);
world.addBody(br);





        /**/
        var skeleton =(function () { 
        //Convert kinect points to PIXI / p2.js space
         
            var skeleton = function(obj) {//init ragdoll
                var self = this; 
                self.name = obj['name'];
                self.o = { mass: 0, position: [0,0] };

                self.points = [
                    self.ankleleft      = new p2.Body(self.o),
                    self.ankleright     = new p2.Body(self.o),
                    self.elbowleft      = new p2.Body(self.o),
                    self.elbowright     = new p2.Body(self.o),
                    self.footleft       = new p2.Body(self.o),
                    self.footright      = new p2.Body(self.o),
                    self.handleft       = new p2.Body(self.o),
                    self.handright      = new p2.Body(self.o),
                    self.head           = new p2.Body(self.o),
                    self.hipcenter      = new p2.Body(self.o),
                    self.hipleft        = new p2.Body(self.o),
                    self.hipright       = new p2.Body(self.o),
                    self.kneeleft       = new p2.Body(self.o),
                    self.kneeright      = new p2.Body(self.o),
                    self.shouldercenter = new p2.Body(self.o),
                    self.shoulderleft   = new p2.Body(self.o),
                    self.shoulderright  = new p2.Body(self.o),
                    self.spine          = new p2.Body(self.o),
                    self.wristleft      = new p2.Body(self.o),
                    self.wristright     = new p2.Body(self.o)
                ]; 

                for (var i = 0; i < self.points.length; i++) {
                    self.points[i].addShape(kinectpShape);
                    world.addBody(self.points[i]);
                }
       
             }//skeleton init
            skeleton.prototype = {

                movePoints: function(obj){

                    this.ankleleft.position       = mapcoords(obj['ankleleft'].x  , obj['ankleleft'].y);
                    this.ankleright.position      = mapcoords(obj['ankleright'].x  , obj['ankleright'].y);
                    this.elbowleft.position       = mapcoords(obj['elbowleft'].x  , obj['elbowleft'].y);
                    this.elbowright.position      = mapcoords(obj['elbowright'].x  , obj['elbowright'].y);
                    this.footleft.position        = mapcoords(obj['footleft'].x  , obj['footleft'].y);
                    this.footright.position       = mapcoords(obj['footright'].x  , obj['footright'].y);
                    this.handleft.position        = mapcoords(obj['handleft'].x  , obj['handleft'].y);
                    this.handright.position       = mapcoords(obj['handright'].x  , obj['handright'].y);
                    this.head.position            = mapcoords(obj['head'].x  , obj['head'].y);
                    this.hipcenter.position       = mapcoords(obj['hipcenter'].x  , obj['hipcenter'].y);
                    this.hipleft.position         = mapcoords(obj['hipleft'].x  , obj['hipleft'].y);
                    this.hipright.position        = mapcoords(obj['hipright'].x  , obj['hipright'].y);
                    this.kneeleft.position        = mapcoords(obj['kneeleft'].x  , obj['kneeleft'].y);
                    this.kneeright.position       = mapcoords(obj['kneeright'].x  , obj['kneeright'].y);
                    this.shouldercenter.position  = mapcoords(obj['shouldercenter'].x  , obj['shouldercenter'].y);
                    this.shoulderleft.position    = mapcoords(obj['shoulderleft'].x  , obj['shoulderleft'].y);
                    this.shoulderright.position   = mapcoords(obj['shoulderright'].x  , obj['shoulderright'].y);
                    this.spine.position           = mapcoords(obj['spine'].x  , obj['spine'].y);
                    this.wristleft.position       = mapcoords(obj['wristleft'].x  , obj['wristleft'].y);
                    this.wristright.position      = mapcoords(obj['wristright'].x  , obj['wristright'].y);
    
                },

                tempconnect : function(obj){

                /*    
                var l = new p2.LinearSpring(this.head, testsk.HEED, {
                    restLength : .25,
                    stiffness : 100,
                    localAnchorA : [-shouldersDistance/2, upperBodyLength/2],
                    localAnchorB : [upperArmLength/2,0],
                });
                //console.log(world);
                world.addSpring(l);
                */

                }

            }//skeleton prototype methods      
            return skeleton;

        })();//skeleton
        /**/





        /*RAGDOLL OBJ*/
        /**/
        var ragdoll =(function () { 

            var ragdoll = function(obj) {//init ragdoll
            var self = this; 

                /* PARAMS
                    obj = {
                        name = ''
                        world = {},
                        dimensions = {}
                    }
                /**/
                
        
            var bodyPartShapes = [];

            var headShape =      new p2.Rectangle(2*headRadius,2*headRadius),
                upperArmShape =  new p2.Rectangle(upperArmLength,upperArmSize),
                lowerArmShape =  new p2.Rectangle(lowerArmLength,lowerArmSize),
                upperBodyShape = new p2.Rectangle(shouldersDistance,upperBodyLength),
                pelvisShape =    new p2.Rectangle(shouldersDistance,pelvisLength),
                upperLegShape =  new p2.Rectangle(upperLegSize,upperLegLength),
                lowerLegShape =  new p2.Rectangle(lowerLegSize,lowerLegLength);/**/


            bodyPartShapes.push(headShape,
                                upperArmShape,
                                lowerArmShape,
                                upperBodyShape,
                                pelvisShape,
                                upperLegShape,
                                lowerLegShape);

            if(true){ //Toggle COLLISION BETWEEN RAGDOLLS
            switch(obj.name){
                case '1':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS1;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '2': 
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS2;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '3':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS3;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS4|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '4':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS4;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS5|BODYPARTS6;
                                }
                break; 
                 case '5':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS5;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS6;
                                }
                break; 
                 case '6':
                                for(var i=0; i<bodyPartShapes.length; i++){
                                    var s = bodyPartShapes[i];
                                    s.collisionGroup = BODYPARTS6;
                                    s.collisionMask =  GROUND|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5;
                                }
                break; 
            }
        }else{//NO COLLISON BETWEEN RAGDOLLS
            for(var i=0; i<bodyPartShapes.length; i++){
                var s = bodyPartShapes[i];
                s.collisionGroup = BODYPARTS;
                s.collisionMask =  GROUND|OTHER;
            }
        }//NO COLLISON BETWEEN RAGDOLLS
            /*
            BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6
            */



            // Lower legs
            var lowerLeftLeg = new p2.Body({
                mass: 1,
                position: [-shouldersDistance/2,lowerLegLength / 2],
            });
            var lowerRightLeg = new p2.Body({
                mass: 1,
                position: [shouldersDistance/2,lowerLegLength / 2],
            });

            lowerLeftLeg.addShape(lowerLegShape);
            lowerRightLeg.addShape(lowerLegShape);
            world.addBody(lowerLeftLeg);
            world.addBody(lowerRightLeg);

            // Upper legs
            var upperLeftLeg = new p2.Body({
                mass: 1,
                position: [-shouldersDistance/2,lowerLeftLeg.position[1]+lowerLegLength/2+upperLegLength / 2],
            });
            var upperRightLeg = new p2.Body({
                mass: 1,
                position: [shouldersDistance/2,lowerRightLeg.position[1]+lowerLegLength/2+upperLegLength / 2],
            });
            upperLeftLeg.addShape(upperLegShape);
            upperRightLeg.addShape(upperLegShape);
            world.addBody(upperLeftLeg);
            world.addBody(upperRightLeg);

            // Pelvis
            var pelvis = new p2.Body({
                mass: 1,
                position: [0, upperLeftLeg.position[1]+upperLegLength/2+pelvisLength/2],
            });
            pelvis.addShape(pelvisShape);
            world.addBody(pelvis);

            // Upper body
            var upperBody = new p2.Body({
                mass: 1,
                position: [0,pelvis.position[1]+pelvisLength/2+upperBodyLength/2],
            });
            upperBody.addShape(upperBodyShape);
            world.addBody(upperBody);

            // Head
            var head = new p2.Body({
                mass: 1,
                position: [0,upperBody.position[1]+upperBodyLength/2+headRadius+neckLength],
            });

            //TEMP
            this.HEED = head;
            //TEMP

            head.addShape(headShape);
            world.addBody(head);

            // Upper arms
            var upperLeftArm = new p2.Body({
                mass: 1,
                position: [-shouldersDistance/2-upperArmLength/2, upperBody.position[1]+upperBodyLength/2],
            });
            var upperRightArm = new p2.Body({
                mass: 1,
                position: [shouldersDistance/2+upperArmLength/2, upperBody.position[1]+upperBodyLength/2],
            });
            upperLeftArm.addShape(upperArmShape);
            upperRightArm.addShape(upperArmShape);
            world.addBody(upperLeftArm);
            world.addBody(upperRightArm);
            /**/






            // lower arms
            var lowerLeftArm = new p2.Body({
                mass: 1,
                position: [ upperLeftArm.position[0] - lowerArmLength/2 - upperArmLength/2,
                            upperLeftArm.position[1]],
            });
            var lowerRightArm = new p2.Body({
                mass: 1,
                position: [ upperRightArm.position[0] + lowerArmLength/2 + upperArmLength/2,
                            upperRightArm.position[1]],
            });
            lowerLeftArm.addShape(lowerArmShape);
            lowerRightArm.addShape(lowerArmShape);
            world.addBody(lowerLeftArm);
            world.addBody(lowerRightArm);






            // Neck joint
            var neckJoint = new p2.RevoluteConstraint(head, upperBody, {
                localPivotA: [0,-headRadius-neckLength/2],
                localPivotB: [0,upperBodyLength/2],
            });

            neckJoint.setLimits(-Math.PI / 8, Math.PI / 8);

            world.addConstraint(neckJoint);

            // Knee joints
            var leftKneeJoint = new p2.RevoluteConstraint(lowerLeftLeg, upperLeftLeg, {
                localPivotA: [0, lowerLegLength/2],
                localPivotB: [0,-upperLegLength/2],
            });
            var rightKneeJoint= new p2.RevoluteConstraint(lowerRightLeg, upperRightLeg, {
                localPivotA: [0, lowerLegLength/2],
                localPivotB:[0,-upperLegLength/2],
            });
            leftKneeJoint.setLimits(-Math.PI / 3, Math.PI / 3);
            rightKneeJoint.setLimits(-Math.PI / 3, Math.PI / 3);
            world.addConstraint(leftKneeJoint);
            world.addConstraint(rightKneeJoint);

            // Hip joints
            var leftHipJoint = new p2.RevoluteConstraint(upperLeftLeg, pelvis, {
                localPivotA: [0, upperLegLength/2],
                localPivotB: [-shouldersDistance/2,-pelvisLength/2],
            });
            var rightHipJoint = new p2.RevoluteConstraint(upperRightLeg, pelvis, {
                localPivotA: [0, upperLegLength/2],
                localPivotB: [shouldersDistance/2,-pelvisLength/2],
            });
          //  leftHipJoint.setLimits(-Math.PI / 8, Math.PI / 8);
          //  rightHipJoint.setLimits(-Math.PI / 8, Math.PI / 8);
            world.addConstraint(leftHipJoint);
            world.addConstraint(rightHipJoint);

            // Spine
            var spineJoint = new p2.RevoluteConstraint(pelvis, upperBody, {
                localPivotA: [0,pelvisLength/2],
                localPivotB: [0,-upperBodyLength/2],
            });
            spineJoint.setLimits(-Math.PI / 8, Math.PI / 8);
            world.addConstraint(spineJoint);

        
            // Shoulders
            var leftShoulder = new p2.RevoluteConstraint(upperBody, upperLeftArm, {
                localPivotA:[-shouldersDistance/2, upperBodyLength/2],
                localPivotB:[upperArmLength/2,0],
            });
            var rightShoulder= new p2.RevoluteConstraint(upperBody, upperRightArm, {
                localPivotA:[shouldersDistance/2,  upperBodyLength/2],
                localPivotB:[-upperArmLength/2,0],
            });
            // leftShoulder.setLimits(-Math.PI / 3, Math.PI / 3);
            // rightShoulder.setLimits(-Math.PI / 3, Math.PI / 3);
            world.addConstraint(leftShoulder);
            world.addConstraint(rightShoulder);

            // Elbow joint
            var leftElbowJoint = new p2.RevoluteConstraint(lowerLeftArm, upperLeftArm, {
                localPivotA: [lowerArmLength/2, 0],
                localPivotB: [-upperArmLength/2,0],
            });
            var rightElbowJoint= new p2.RevoluteConstraint(lowerRightArm, upperRightArm, {
                localPivotA:[-lowerArmLength/2,0],
                localPivotB:[upperArmLength/2,0],
            });
           // leftElbowJoint.setLimits(-Math.PI / 8, Math.PI / 8);
           // rightElbowJoint.setLimits(-Math.PI / 8, Math.PI / 8);
            world.addConstraint(leftElbowJoint);
            world.addConstraint(rightElbowJoint);

        



              }//initragdoll

              ragdoll.prototype = {

                    bindToSkeleton : function(obj){//Bind to Kinect Skeleton

                    },
                    unbindFromSkeleton : function(obj){//unbind from Kinect Skeleton

                    },
                    decorate : function(obj){//decorate limbs with sprites

                    }

               }//ragdoll prototype methods      

            return ragdoll;
        })();//ragdoll
        /**/
/*
        var r1 = new ragdoll({
            name:'1'
        });
*/



       window.setTimeout(function(){ 
            var r1 = new ragdoll({
                name:'1'
             });
         },1000);

        window.setTimeout(function(){ 
            var r2 = new ragdoll({
                name:'2'
             });
         },2000);
        window.setTimeout(function(){ 
            var r3 = new ragdoll({
                name:'3'
             });
         },3000);
        window.setTimeout(function(){ 
            var r4 = new ragdoll({
                name:'4'
             });
         },4000);

        window.setTimeout(function(){ 
            var r5 = new ragdoll({
                name:'5'
             });
         },5000);

        window.setTimeout(function(){ 
            var r6 = new ragdoll({
                name:'6'
             });
         },6000); /* */



            // Create ground
            var planeShape = new p2.Plane();
            var plane = new p2.Body({
                position:[0,-1],
            });

            testsk = new skeleton({'name' : ''});
            window.setTimeout(function(){
                    testsk.tempconnect({});
            },100);

            plane.addShape(planeShape);
            planeShape.collisionGroup = GROUND;
            planeShape.collisionMask =  BODYPARTS|OTHER|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
            world.addBody(plane);

            this.newShapeCollisionGroup = OTHER;
            this.newShapeCollisionMask =  BODYPARTS|OTHER|GROUND|BODYPARTS1|BODYPARTS2|BODYPARTS3|BODYPARTS4|BODYPARTS5|BODYPARTS6;
            

        });
/**/



  



    </script>


</body></html>